0x2Fd9c9C04b1BE92Fa166bd06B9F680683C5032cf   

// SPDX-License-Identifier: MIT
pragma solidity ^0.8.30;

interface IERC721 {
    function balanceOf(address owner) external view returns (uint256);
}

interface IERC20 {
    function transfer(address to, uint256 amount) external returns (bool);
    function transferFrom(address from, address to, uint256 amount) external returns (bool);
}

contract DeVote {
    address public owner;
    address public constant OG_NFT = 0xD5D2bEf311431F1b464E6637C4F2056EFEe1f82c;
    address public constant FARM_NFT = 0xFB284cA86D797DA6f9176E51cb7836C2794111e5;
    address public constant HASH_TOKEN = 0xA9B631ABcc4fd0bc766d7C0C8fCbf866e2bB0445;
    
    mapping(address => bool) public blacklist;
    
    struct Proposal {
        uint256 id;
        address creator;
        string title;
        string description;
        uint256 endTime;
        uint256 forVotes;
        uint256 againstVotes;
        uint256 abstainVotes;
        uint256 rewardAmount;
        uint256 claimedAmount;
        uint256 voterCount;
        bool deleted;
    }
    
    uint256 public proposalCount;
    mapping(uint256 => Proposal) public proposals;
    uint256[] public allProposalIds;

    mapping(uint256 => mapping(address => bool)) public hasVoted;
    mapping(uint256 => mapping(address => bool)) public hasClaimed;
    
    event ProposalCreated(uint256 indexed id, address indexed creator, uint256 amount);
    event VoteCast(uint256 indexed proposalId, address indexed voter, uint8 voteType);
    event RewardClaimed(uint256 indexed proposalId, address indexed voter, uint256 amount);
    event RewardRefunded(uint256 indexed proposalId, address indexed creator, uint256 amount);
    event Blacklisted(address indexed user);
    event UnBlacklisted(address indexed user);
    event OwnershipTransferred(address indexed previousOwner, address indexed newOwner);
    
    modifier onlyOwner() {
        require(msg.sender == owner, "Not owner");
        _;
    }
    
    modifier notBlacklisted() {
        require(!blacklist[msg.sender], "Blacklisted");
        _;
    }
    
    constructor() {
        owner = msg.sender;
    }

    // --- Admin Functions ---

    function transferOwnership(address newOwner) external onlyOwner {
        require(newOwner != address(0), "New owner is zero address");
        emit OwnershipTransferred(owner, newOwner);
        owner = newOwner;
    }

    function addToBlacklist(address user) external onlyOwner {
        blacklist[user] = true;
        emit Blacklisted(user);
    }
    
    function removeFromBlacklist(address user) external onlyOwner {
        blacklist[user] = false;
        emit UnBlacklisted(user);
    }

    function extendProposalTime(uint256 proposalId, uint256 extraTimeSeconds) external onlyOwner {
        Proposal storage p = proposals[proposalId];
        require(!p.deleted, "Deleted");
        require(p.id != 0, "Not found");
        p.endTime += extraTimeSeconds;
    }

    function deleteProposal(uint256 proposalId) external onlyOwner {
        Proposal storage p = proposals[proposalId];
        require(!p.deleted, "Already deleted");
        
        if (p.rewardAmount > p.claimedAmount && block.timestamp > p.endTime) {
            uint256 unclaimed = p.rewardAmount - p.claimedAmount;
            if (unclaimed > 0) {
                IERC20(HASH_TOKEN).transfer(p.creator, unclaimed);
            }
        }
        p.deleted = true;
    }

    // --- Core Functions ---

    function createProposal(
        string calldata title,
        string calldata description,
        uint256 rewardAmount
    ) external notBlacklisted {
        require(IERC721(OG_NFT).balanceOf(msg.sender) > 0, "Not OG holder");
        require(bytes(title).length > 0 && bytes(title).length <= 100, "Invalid title");
        require(rewardAmount > 0, "Reward required");

        bool success = IERC20(HASH_TOKEN).transferFrom(msg.sender, address(this), rewardAmount);
        require(success, "Transfer failed");
        
        proposalCount++;
        proposals[proposalCount] = Proposal({
            id: proposalCount,
            creator: msg.sender,
            title: title,
            description: description,
            endTime: block.timestamp + 3 days,
            forVotes: 0,
            againstVotes: 0,
            abstainVotes: 0,
            rewardAmount: rewardAmount,
            claimedAmount: 0,
            voterCount: 0,
            deleted: false
        });

        allProposalIds.push(proposalCount);
        emit ProposalCreated(proposalCount, msg.sender, rewardAmount);
    }
    
    function vote(uint256 proposalId, uint8 voteType) external notBlacklisted {
        require(IERC721(FARM_NFT).balanceOf(msg.sender) > 0, "Not FARM holder");
        Proposal storage p = proposals[proposalId];
        
        require(!p.deleted, "Deleted");
        require(block.timestamp <= p.endTime, "Ended");
        require(!hasVoted[proposalId][msg.sender], "Already voted");
        require(voteType <= 2, "Invalid vote");
        
        hasVoted[proposalId][msg.sender] = true;
        p.voterCount++;
        
        if (voteType == 0) p.forVotes++;
        else if (voteType == 1) p.againstVotes++;
        else p.abstainVotes++;
        
        emit VoteCast(proposalId, msg.sender, voteType);
    }
    
    function claimReward(uint256 proposalId) external notBlacklisted {
        Proposal storage p = proposals[proposalId];
        
        require(!p.deleted, "Deleted");
        require(block.timestamp > p.endTime, "Not ended");
        require(p.voterCount > 0, "No voters");
        require(hasVoted[proposalId][msg.sender], "Did not vote");
        require(!hasClaimed[proposalId][msg.sender], "Already claimed");
        
        uint256 share = p.rewardAmount / p.voterCount;
        require(share > 0, "Zero share");
        require(p.claimedAmount + share <= p.rewardAmount, "Insufficient funds");
        
        p.claimedAmount += share;
        hasClaimed[proposalId][msg.sender] = true;
        
        require(IERC20(HASH_TOKEN).transfer(msg.sender, share), "Transfer failed");
        emit RewardClaimed(proposalId, msg.sender, share);
    }
    
    function refundToCreator(uint256 proposalId) external {
        Proposal storage p = proposals[proposalId];
        require(!p.deleted && block.timestamp > p.endTime + 7 days, "Conditions not met");
        require(msg.sender == p.creator, "Not creator");
        
        uint256 unclaimed = p.rewardAmount - p.claimedAmount;
        require(unclaimed > 0, "Nothing to refund");
        
        p.claimedAmount = p.rewardAmount;
        require(IERC20(HASH_TOKEN).transfer(p.creator, unclaimed), "Transfer failed");
        emit RewardRefunded(proposalId, p.creator, unclaimed);
    }

    // --- View Functions ---

    function getProposal(uint256 proposalId) external view returns (Proposal memory) {
        return proposals[proposalId];
    }

    function getActiveProposals() external view returns (uint256[] memory) {
        uint256 count;
        for (uint256 i = 0; i < allProposalIds.length; i++) {
            Proposal storage p = proposals[allProposalIds[i]];
            if (!p.deleted && block.timestamp <= p.endTime) count++;
        }
        uint256[] memory result = new uint256[](count);
        uint256 index;
        for (uint256 i = 0; i < allProposalIds.length; i++) {
            Proposal storage p = proposals[allProposalIds[i]];
            if (!p.deleted && block.timestamp <= p.endTime) result[index++] = p.id;
        }
        return result;
    }

    function getFinishedProposals() external view returns (uint256[] memory) {
        uint256 count;
        for (uint256 i = 0; i < allProposalIds.length; i++) {
            Proposal storage p = proposals[allProposalIds[i]];
            if (!p.deleted && block.timestamp > p.endTime) count++;
        }
        uint256[] memory result = new uint256[](count);
        uint256 index;
        for (uint256 i = 0; i < allProposalIds.length; i++) {
            Proposal storage p = proposals[allProposalIds[i]];
            if (!p.deleted && block.timestamp > p.endTime) result[index++] = p.id;
        }
        return result;
    }
}



________________________________________________________


abi

[
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "user",
				"type": "address"
			}
		],
		"name": "addToBlacklist",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "proposalId",
				"type": "uint256"
			}
		],
		"name": "claimReward",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"stateMutability": "nonpayable",
		"type": "constructor"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "user",
				"type": "address"
			}
		],
		"name": "Blacklisted",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "title",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "description",
				"type": "string"
			},
			{
				"internalType": "uint256",
				"name": "rewardAmount",
				"type": "uint256"
			}
		],
		"name": "createProposal",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "proposalId",
				"type": "uint256"
			}
		],
		"name": "deleteProposal",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "proposalId",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "extraTimeSeconds",
				"type": "uint256"
			}
		],
		"name": "extendProposalTime",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "previousOwner",
				"type": "address"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "newOwner",
				"type": "address"
			}
		],
		"name": "OwnershipTransferred",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "id",
				"type": "uint256"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "creator",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "amount",
				"type": "uint256"
			}
		],
		"name": "ProposalCreated",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "proposalId",
				"type": "uint256"
			}
		],
		"name": "refundToCreator",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "user",
				"type": "address"
			}
		],
		"name": "removeFromBlacklist",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "proposalId",
				"type": "uint256"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "voter",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "amount",
				"type": "uint256"
			}
		],
		"name": "RewardClaimed",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "proposalId",
				"type": "uint256"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "creator",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "amount",
				"type": "uint256"
			}
		],
		"name": "RewardRefunded",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "newOwner",
				"type": "address"
			}
		],
		"name": "transferOwnership",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "user",
				"type": "address"
			}
		],
		"name": "UnBlacklisted",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "proposalId",
				"type": "uint256"
			},
			{
				"internalType": "uint8",
				"name": "voteType",
				"type": "uint8"
			}
		],
		"name": "vote",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "proposalId",
				"type": "uint256"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "voter",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint8",
				"name": "voteType",
				"type": "uint8"
			}
		],
		"name": "VoteCast",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "allProposalIds",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"name": "blacklist",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "FARM_NFT",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "getActiveProposals",
		"outputs": [
			{
				"internalType": "uint256[]",
				"name": "",
				"type": "uint256[]"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "getFinishedProposals",
		"outputs": [
			{
				"internalType": "uint256[]",
				"name": "",
				"type": "uint256[]"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "proposalId",
				"type": "uint256"
			}
		],
		"name": "getProposal",
		"outputs": [
			{
				"components": [
					{
						"internalType": "uint256",
						"name": "id",
						"type": "uint256"
					},
					{
						"internalType": "address",
						"name": "creator",
						"type": "address"
					},
					{
						"internalType": "string",
						"name": "title",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "description",
						"type": "string"
					},
					{
						"internalType": "uint256",
						"name": "endTime",
						"type": "uint256"
					},
					{
						"internalType": "uint256",
						"name": "forVotes",
						"type": "uint256"
					},
					{
						"internalType": "uint256",
						"name": "againstVotes",
						"type": "uint256"
					},
					{
						"internalType": "uint256",
						"name": "abstainVotes",
						"type": "uint256"
					},
					{
						"internalType": "uint256",
						"name": "rewardAmount",
						"type": "uint256"
					},
					{
						"internalType": "uint256",
						"name": "claimedAmount",
						"type": "uint256"
					},
					{
						"internalType": "uint256",
						"name": "voterCount",
						"type": "uint256"
					},
					{
						"internalType": "bool",
						"name": "deleted",
						"type": "bool"
					}
				],
				"internalType": "struct DeVote.Proposal",
				"name": "",
				"type": "tuple"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			},
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"name": "hasClaimed",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "HASH_TOKEN",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			},
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"name": "hasVoted",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "OG_NFT",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "owner",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "proposalCount",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "proposals",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "id",
				"type": "uint256"
			},
			{
				"internalType": "address",
				"name": "creator",
				"type": "address"
			},
			{
				"internalType": "string",
				"name": "title",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "description",
				"type": "string"
			},
			{
				"internalType": "uint256",
				"name": "endTime",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "forVotes",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "againstVotes",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "abstainVotes",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "rewardAmount",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "claimedAmount",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "voterCount",
				"type": "uint256"
			},
			{
				"internalType": "bool",
				"name": "deleted",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	}
]